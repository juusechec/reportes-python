#!/usr/bin/env python3
def load_src(name, fpath):
    import os
    import imp
    return imp.load_source(name, os.path.join(os.path.dirname(__file__), fpath))
load_src("arcgis", "repo/arcgis/arcgis.py")

def guardar_imagen(self, dir_imagenes="imagenes"):
    import arcgis
    import map_print
    from urllib.request import urlretrieve
    import os

    source = "https://services7.arcgis.com/lUZlLTBKH3INlBpk/arcgis/rest/services/Poste_etb/FeatureServer"
    username = os.getenv('ARCGIS_USERNAME', None)
    password = os.getenv('ARCGIS_PASSWORD', None)
    OBJECTID = "FID"  # la fila OBJECTID no está en el servicio
    service = arcgis.ArcGIS(source,
                            username=username,
                            password=password,
                            object_id_field=OBJECTID)
    layer_id = 0
    #geojson = service.get(layer_id)
    #print(geojson)
    impresora = map_print.Printer()
    #gpstring = """{"mapOptions":{"showAttribution":true,"extent":{"xmin":-10492931.935418567,"ymin":3312478.4899813985,"xmax":-9981721.090247335,"ymax":3737468.367246957,"spatialReference":{"wkid":102100,"latestWkid":3857}},"spatialReference":{"wkid":102100,"latestWkid":3857}},"operationalLayers":[{"id":"Ocean","title":"Ocean","opacity":1,"minScale":591657527.591555,"maxScale":9027.977411,"url":"https://services.arcgisonline.com/ArcGIS/rest/services/Ocean_Basemap/MapServer"},{"id":"County Population","title":"County Population","opacity":0.5,"minScale":0,"maxScale":0,"url":"https://sampleserver6.arcgisonline.com/arcgis/rest/services/USA/MapServer","layers":[{"id":3,"name":"Counties","layerDefinition":{"source":{"type":"mapLayer","mapLayerId":3},"definitionExpression":"state_name = 'Louisiana'","drawingInfo":{"renderer":{"type":"classBreaks","field":"pop2000","defaultSymbol":null,"minValue":0,"classBreakInfos":[{"symbol":{"color":[255,255,178,128],"outline":{"color":[0,0,0,128],"width":0.75,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSSolid"},"classMaxValue":20000},{"symbol":{"color":[254,204,92,128],"outline":{"color":[0,0,0,128],"width":0.75,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSSolid"},"classMaxValue":50000},{"symbol":{"color":[253,141,60,128],"outline":{"color":[0,0,0,128],"width":0.75,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSSolid"},"classMaxValue":100000},{"symbol":{"color":[240,59,32,128],"outline":{"color":[0,0,0,128],"width":0.75,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSSolid"},"classMaxValue":1000000},{"symbol":{"color":[189,0,38,128],"outline":{"color":[0,0,0,128],"width":0.75,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSSolid"},"classMaxValue":10000000}]}}}}]},{"id":"map_graphics","opacity":1,"minScale":0,"maxScale":0,"featureCollection":{"layers":[{"layerDefinition":{"name":"polygonLayer","geometryType":"esriGeometryPolygon"},"featureSet":{"geometryType":"esriGeometryPolygon","features":[{"geometry":{"rings":[[[-10145233.148496136,3586428.799355456],[-10145958.735042285,3572583.783289588],[-10148127.545002699,3558890.4561169934],[-10151715.816441594,3545498.8447956885],[-10156684.235506194,3532555.670621684],[-10162978.367157517,3520202.7417197633],[-10170529.251572061,3508575.3993639927],[-10179254.159680055,3497801.0351504004],[-10189057.499562467,3487997.69526799],[-10199831.863776058,3479272.7871599956],[-10211459.206131829,3471721.9027454513],[-10223812.135033749,3465427.7710941276],[-10236755.309207754,3460459.3520295275],[-10250146.92052906,3456871.0805906327],[-10263840.247701654,3454702.2706302204],[-10277685.263767522,3453976.6840840704],[-10291530.27983339,3454702.2706302204],[-10305223.607005985,3456871.0805906327],[-10318615.21832729,3460459.3520295275],[-10331558.392501295,3465427.7710941276],[-10343911.321403215,3471721.9027454513],[-10355538.663758986,3479272.7871599956],[-10366313.027972577,3487997.69526799],[-10376116.367854988,3497801.0351504004],[-10384841.275962982,3508575.3993639927],[-10392392.160377527,3520202.7417197633],[-10398686.29202885,3532555.670621684],[-10403654.71109345,3545498.8447956885],[-10407242.982532345,3558890.4561169934],[-10409411.792492758,3572583.783289588],[-10410137.379038908,3586428.799355456],[-10409411.792492758,3600273.815421324],[-10407242.982532345,3613967.142593919],[-10403654.71109345,3627358.7539152238],[-10398686.29202885,3640301.9280892285],[-10392392.160377527,3652654.856991149],[-10384841.275962982,3664282.1993469195],[-10376116.367854988,3675056.563560512],[-10366313.027972577,3684859.903442922],[-10355538.663758986,3693584.811550917],[-10343911.321403215,3701135.6959654614],[-10331558.392501295,3707429.827616785],[-10318615.21832729,3712398.2466813847],[-10305223.607005985,3715986.51812028],[-10291530.27983339,3718155.328080692],[-10277685.263767522,3718880.9146268424],[-10263840.247701654,3718155.328080692],[-10250146.92052906,3715986.51812028],[-10236755.309207754,3712398.2466813847],[-10223812.135033749,3707429.827616785],[-10211459.206131829,3701135.6959654614],[-10199831.863776058,3693584.811550917],[-10189057.499562467,3684859.903442922],[-10179254.159680055,3675056.563560512],[-10170529.251572061,3664282.1993469195],[-10162978.367157517,3652654.856991149],[-10156684.235506194,3640301.928089229],[-10151715.816441594,3627358.753915224],[-10148127.545002699,3613967.142593919],[-10145958.735042285,3600273.815421324],[-10145233.148496136,3586428.799355456]]],"spatialReference":{"wkid":102100,"latestWkid":3857}},"symbol":{"color":[0,0,180,64],"outline":{"color":[0,0,0,255],"width":1,"type":"esriSLS","style":"esriSLSSolid"},"type":"esriSFS","style":"esriSFSSolid"}}]}},{"layerDefinition":{"name":"polylineLayer","geometryType":"esriGeometryPolyline"},"featureSet":{"geometryType":"esriGeometryPolyline","features":[{"geometry":{"paths":[[[-10143156.093985619,3485531.9220190286],[-10150494.048700996,3489200.899376717],[-10282577.233577773,3586428.799355456],[-10301533.616592497,3561968.950304201],[-10322935.984512344,3503876.80880747],[-10327216.458096314,3480028.455982496],[-10322324.488286063,3405425.916376168],[-10314375.037344405,3340607.3163903416],[-10245887.46000089,3361398.1880839085],[-10113192.778897831,3410929.3824127004],[-10118084.748708082,3420101.825806921],[-10126645.695876021,3508157.2823914397],[-10129091.680781147,3503265.3125811885],[-10155997.514737528,3506322.7937125955],[-10161500.98077406,3508157.2823914397],[-10161500.98077406,3508157.2823914397]]],"spatialReference":{"wkid":102100,"latestWkid":3857}},"symbol":{"color":[255,128,0,255],"width":1.5,"type":"esriSLS","style":"esriSLSSolid"}}]}},{"layerDefinition":{"name":"pointLayer","geometryType":"esriGeometryPoint"},"featureSet":{"geometryType":"esriGeometryPoint","features":[{"geometry":{"x":-10285634.71470918,"y":3516718.229559379,"spatialReference":{"wkid":102100,"latestWkid":3857}},"symbol":{"color":[0,255,0,191],"size":7.5,"angle":0,"xoffset":0,"yoffset":0,"type":"esriSMS","style":"esriSMSSquare","outline":{"color":[0,0,0,255],"width":1,"type":"esriSLS","style":"esriSLSSolid"}}}]}}]}}],"exportOptions":{"outputSize":[800,1100],"dpi":96}}"""
    gpstring = """{"mapOptions":{"showAttribution":true,"extent":{"xmin":-8250416.766858629,"ymin":515917.1351499202,"xmax":-8246671.352472556,"ymax":519710.322678672,"spatialReference":{"wkid":102100}},"spatialReference":{"wkid":102100},"scale":18055.95482200396},"operationalLayers":[{"id":"defaultBasemap","title":"Topográfico","opacity":1,"minScale":591657527.591555,"maxScale":70.5310735,"url":"https://services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer"},{"id":"Geodatabase_Redes_CAN_4074","title":"Geodatabase Redes CAN - Poste_etb","opacity":1,"minScale":36112,"maxScale":0,"layerDefinition":{"drawingInfo":{"renderer":{"type":"simple","symbol":{"angle":0,"xoffset":0,"yoffset":0,"type":"esriPMS","url":"RedSphere.png","imageData":"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","contentType":"image/png","width":15,"height":15}}}},"token":"nXJ5hYlwUmLV6j-uI7eBc1tazQkaPpH9PBggdPJ9yJgBKxkj603WLfkplYF-x8eibMyKoGOQfj2Em6Cr_tZQuG1JgIJsgGwSW2Tt02DAqCCo13W_hnDzFJAOGAMdSQBZp3SJK2tQ9Zq3Dj8kYBsn8ktRXD-ehApQkTxQptwdcKlr7FWpg8uYEGgvjJ6z4qcm_L0JGcG2tsx3X8yUvpk1i3n11seuYJVQRQTXpFNpWEMylM2B6vSI2_8a8muKLll7ZbQnR7GF1zGUakYYi_2WLw..","url":"https://services7.arcgis.com/lUZlLTBKH3INlBpk/arcgis/rest/services/Geodatabase_Redes_CAN/FeatureServer/0"},{"id":"graphicsLayer1","opacity":1,"minScale":0,"maxScale":0,"featureCollection":{"layers":[]}},{"id":"map_graphics","opacity":1,"minScale":0,"maxScale":0,"featureCollection":{"layers":[]}}],"exportOptions":{"outputSize":[670,500],"dpi":96},"layoutOptions":{"titleText":"","authorText":"","copyrightText":"","customTextElements":[],"scaleBarOptions":{},"legendOptions":{"operationalLayers":[]}}}"""
    url_imagen = impresora.get_image(Web_Map_as_JSON=gpstring)
    print(url_imagen)

    nombre_imagen = url_imagen[url_imagen.rfind("/") + 1:]
    destino_imagen = os.path.dirname(__file__) + "/" + dir_imagenes + "/" + nombre_imagen
    urlretrieve(url_imagen, destino_imagen)

    dict = {'nombre_imagen': nombre_imagen, 'dir_imagen': destino_imagen}
    return dict
    #return os.path.dirname(__file__) + "/result.png"
